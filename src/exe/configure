#!/bin/sh
. .lib.configure
if [ "$DIR" = '.' ]; then
	err This script is not intended to be executed directly
	exit 1
fi

unset -v EXECUTABLES
unset -v DEBUG_EXECUTABLES
for file in "${DIR}"/*.c; do
	EXECUTABLES="$(basename "${file%.c}") ${EXECUTABLES}"
done
EXECUTABLES="${EXECUTABLES## }"
EXECUTABLES="${EXECUTABLES%% }"
for executable in $EXECUTABLES; do
	DEBUG_EXECUTABLES="${executable}_debug ${DEBUG_EXECUTABLES}"
done
DEBUG_EXECUTABLES="${DEBUG_EXECUTABLES## }"
DEBUG_EXECUTABLES="${DEBUG_EXECUTABLES%% }"

sed -e "s|@@EXECUTABLES@@|$EXECUTABLES|g" \
	-e "s|@@DEBUG_EXECUTABLES@@|$DEBUG_EXECUTABLES|g" \
	-e "s|@@EXE_MAKEFILE@@|${DIR}/makefile.in|g" \
	"${DIR}/makefile.in"

for file in "${DIR}"/*.c; do
	unset -f deps
	deps="${file%.c}.o"
	for header in $(recurse_headers "$file"); do
		if echo "$header" | grep -q "^${srcdir}/mod/"; then
			deps="$deps ${header%.h}.o"
		fi
	done
	echo "$(basename "${file%.c}")_src = $deps"
	echo "$(basename "${file%.c}"):      $deps"
done

# vim: nowrap
